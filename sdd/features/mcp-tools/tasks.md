# Tasks: mcp-tools

[This file is generated by /prompts:sdd-tasks and tracks implementation progress]

## Task T001: Define MCP Server Configuration
**Status:** Completed
**Dependencies:** None
**Files:**
- `config/mcp-servers.json`
- `app/lib/mcp/config.ts`
- `tests/mcp/config-validation.test.ts`

### Description
Introduce a versioned config file that lists MCP servers as stdio shell commands and add validation utilities to load it safely at runtime.

### Acceptance Criteria
- Config file structure supports command, args, description, and enabled flag for each server
- Loader validates commands, rejects duplicates, and logs actionable errors
- Unit tests cover valid/invalid configs and default fallbacks

### Implementation Notes
- Reference spec Story 4
- Document config format in README once validation is in place

---

## Task T002: Manage MCP Server Processes
**Status:** Completed
**Dependencies:** T001
**Files:**
- `app/lib/mcp/serverManager.ts`
- `app/lib/mcp/process-registry.ts`
- `tests/mcp/server-manager.test.ts`

### Description
Create a server manager that spawns configured MCP servers over stdio, monitors health, and exposes metadata for discovery.

### Acceptance Criteria
- Configured commands launch via child processes with stdio pipes and graceful shutdown
- Health checks restart failed servers with backoff and surface status to diagnostics
- Tests mock child processes to verify spawn, restart, and teardown flows

### Implementation Notes
- Ensure processes inherit required env vars without leaking secrets
- Reference spec Stories 1 and 4

---

## Task T003: Aggregate MCP Tool Catalog
**Status:** Pending
**Dependencies:** T002
**Files:**
- `app/lib/mcp/catalog-service.ts`
- `app/api/mcp/catalog/route.ts`
- `tests/mcp/catalog-service.test.ts`

### Description
Query all running MCP servers for their tool metadata and expose a unified catalog endpoint for session handshakes.

### Acceptance Criteria
- Catalog service fetches identifiers, schemas, transport (stdio), and permission scopes from every server
- Endpoint responds within 500ms under mocked load and omits disabled or unauthorized tools
- Tests cover multi-server aggregation, error handling, and response normalization

### Implementation Notes
- Reference spec Story 1
- Cache recent catalog responses to avoid redundant server calls

---

## Task T004: Hydrate Client Agent With Catalog
**Status:** Pending
**Dependencies:** T003
**Files:**
- `app/lib/voice-agent/mcp-adapter.ts`
- `app/chat-client.tsx`
- `tests/chat/mcp-catalog.test.tsx`

### Description
Integrate the unified catalog into the client voice agent so tools register on session connect and surface through the conversational planner.

### Acceptance Criteria
- Client fetches catalog during connect, handles retries, and registers tools without blocking UI
- Catalog refreshes when the session receives update notifications
- Tests validate catalog hydration, error surfacing, and that disabled tools never appear

### Implementation Notes
- Reference spec Story 1
- Follow existing agent hook patterns to keep testability

---

## Task T005: Implement Tool Invocation Pipeline
**Status:** Pending
**Dependencies:** T002
**Files:**
- `app/lib/mcp/invocation-service.ts`
- `app/api/mcp/invoke/route.ts`
- `tests/mcp/invocation-service.test.ts`

### Description
Handle tool invocation requests from the agent, forward them to the correct MCP server, and stream results back within latency targets.

### Acceptance Criteria
- Invocation payloads validate against advertised schemas before execution
- Responses stream to the client with ≤1s median latency in integration tests
- Failures return actionable errors and never crash the invocation service

### Implementation Notes
- Reference spec Story 2
- Reuse existing transport abstractions where possible

---

## Task T006: Connect Voice Agent To MCP Invocations
**Status:** Pending
**Dependencies:** T004, T005
**Files:**
- `app/lib/voice-agent/tool-runner.ts`
- `app/components/voice-session-hooks.ts`
- `tests/chat/mcp-invocation.test.tsx`

### Description
Wire the voice agent to call the invocation endpoint, process streamed responses, and present outputs while respecting session permissions.

### Acceptance Criteria
- Agent requests include required permission tokens and correlate responses to conversational turns
- UI reflects tool progress, success, and error messages without blocking voice playback
- Tests mock tool runs to cover success, failure, and permission denial paths

### Implementation Notes
- Reference spec Story 2
- Ensure telemetry hooks can observe each invocation phase

---

## Task T007: Instrument Telemetry And Logging
**Status:** Pending
**Dependencies:** T005
**Files:**
- `app/lib/analytics.ts`
- `app/lib/mcp/telemetry.ts`
- `tests/mcp/telemetry.test.ts`

### Description
Capture handshake, invocation latency, and outcome metrics while forwarding them to analytics with correlation ids for support diagnostics.

### Acceptance Criteria
- Telemetry events include tool name, session id, latency, and result status
- Analytics pipeline records success and error cases without duplicate events
- Tests verify emitted events for handshake, success, and failure scenarios

### Implementation Notes
- Reference spec Story 3
- Align with existing telemetry toggle env vars

---

## Task T008: Provide Kill Switch And Config Reload
**Status:** Pending
**Dependencies:** T002, T005
**Files:**
- `app/api/mcp/admin/route.ts`
- `app/lib/mcp/serverManager.ts`
- `tests/mcp/admin-controls.test.ts`

### Description
Expose administrative controls to revoke tools mid-session, cancel active invocations, and reload the MCP server config without redeploying.

### Acceptance Criteria
- Kill switch endpoint revokes selected tools, cancels active runs, and logs audit entries
- Config reload command picks up changes to `mcp-servers.json` and updates running catalog within 60s
- Tests cover revocation, reload success, and permission checks for admin routes

### Implementation Notes
- Reference spec Story 3 and Story 4
- Restrict endpoints to authenticated support roles

---

## Task T009: End-to-End Validation And Documentation
**Status:** Pending
**Dependencies:** T004, T006, T007, T008
**Files:**
- `tests/e2e/mcp-tools.spec.ts`
- `AGENTS.md`
- `README.md`

### Description
Add Playwright coverage for catalog download and invocation flows, verify telemetry toggles, and document MCP configuration plus operational runbooks.

### Acceptance Criteria
- Playwright test covers handshake, successful tool run, telemetry assertions, and kill-switch behavior with mocks
- Documentation explains config format, deployment steps, and troubleshooting signals
- Coverage reports confirm ≥80% line coverage maintained after new tests

### Implementation Notes
- Reference all spec stories
- Include bundle/timing metrics in release notes if thresholds regress

---
