# Tasks: mcp-resources-tracking

[This file is generated by /prompts:sdd-tasks and tracks implementation progress]

## Task T001: Config flag + validation
**Status:** Completed
**Dependencies:** None
**Files:**
- `config/mcp-servers.json`
- `app/lib/mcp/config.ts`
- `AGENTS.md`, `README.md`

### Description
Extend the MCP server config schema with an optional boolean `trackResources` defaulting to false, surface it through runtime definitions, and document how to enable it. Include sample config guidance.

### Acceptance Criteria
- Config parser accepts `trackResources` and rejects non-boolean values
- Runtime consumers (`McpServerManager`, `ProcessRegistry`, etc.) keep the flag on server definitions
- Docs describe when to enable the flag and capability requirements
- Unit tests cover parsing defaults and invalid values

### Implementation Notes
- Reference spec Story 1
- Keep formatting consistent with existing config docs

---

## Task T002: Resource tracker service
**Status:** Pending
**Dependencies:** T001
**Files:**
- `app/lib/mcp/resource-tracker.ts` (new)
- `app/lib/mcp/runtime.ts`
- `tests/mcp/resource-tracker.test.ts`

### Description
Create a tracker tied to `McpServerManager`/`McpClientPool` that, for servers with `trackResources=true`, lists resources, subscribes to each, handles `list_changed`, deduplicates notifications, retries failures, and emits normalized update events.

### Acceptance Criteria
- Tracker starts within 5s of eligible server startup and tears down on stop/reload
- `notifications/resources/list_changed` triggers full refresh + resubscribe atomically
- Duplicate update notifications for same URI within 2s collapse to one event
- Retries use exponential backoff capped at 30s and emit telemetry/logs on failure
- Unit tests cover lifecycle, dedupe, and retry behavior

### Implementation Notes
- Reference spec Stories 1 & 2
- Use existing telemetry utilities for logging health events

---

## Task T003: SSE resource event delivery
**Status:** Pending
**Dependencies:** T002
**Files:**
- `app/api/mcp/resource-events/route.ts` (new)
- `tests/api/mcp/resource-events.test.ts`

### Description
Expose tracker events via a server-sent events endpoint so UI/clients can observe resource updates. Handle subscription management, heartbeats, and cleanup when connections close.

### Acceptance Criteria
- SSE stream emits initial handshake and subsequent update events with serverId, resource URI, timestamp, preview text
- Connections auto-close on tracker disposal and remove listeners immediately
- Heartbeat/ping keeps connections alive; reconnect guidance via headers
- Endpoint restricted to authenticated contexts (reuse existing auth middleware if any)
- Integration test validates streaming of mocked tracker events

### Implementation Notes
- Reference spec Story 3 (SSE requirement)
- Ensure no sensitive data logged when streaming contents

---

## Task T004: Realtime adapter & agent messaging
**Status:** Pending
**Dependencies:** T002, T003
**Files:**
- `app/lib/voice-agent/mcp-adapter.ts`
- `tests/chat/mcp-resource-updates.test.tsx`

### Description
Wire the `McpAdapter` to the SSE feed, forward resource updates into live realtime sessions by sending the formatted message (`Resource <URI> updated:\n<contents>`), handle binary/large payload summarization, and ensure retry/backoff on SSE failures.

### Acceptance Criteria
- Adapter opens SSE when a session attaches and closes on detach/unmount
- Realtime message injected within 3s of tracker event, including mock session tests
- Contents truncated to 4 KB; binary payloads replaced with placeholder notice
- Duplicate updates ignored if same URI + checksum already delivered
- Jest tests cover SSE consumption, formatting, and messaging behavior

### Implementation Notes
- Reference spec Story 3
- Reuse existing transcript/message utilities to avoid duplicate logic

---

## Task T005: Documentation & end-to-end validation
**Status:** Pending
**Dependencies:** T001â€“T004
**Files:**
- `README.md`, `AGENTS.md`
- `sdd/features/mcp-resources-tracking/spec.md`
- `tests/e2e/mcp-resource-tracking.spec.ts` (new)

### Description
Update project docs and SDD materials with tracker details plus add an end-to-end Playwright (or Jest integration) scenario exercising the full flow from config flag to realtime message delivery.

### Acceptance Criteria
- Docs explain setup steps, telemetry expectations, and troubleshooting
- SDD spec cross-referenced with new tasks completion states
- E2E test validates that editing a mock resource triggers tracker refresh and realtime message in UI
- Test evidence captured for CI (`npm test`, `npm run test:e2e`) once implemented

### Implementation Notes
- Reference all spec stories for coverage
- Coordinate with telemetry team if new events exposed externally

---
