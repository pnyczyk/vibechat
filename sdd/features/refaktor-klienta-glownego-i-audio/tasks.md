# Tasks: refaktor-klienta-glownego-i-audio

[This file is generated by /prompts:sdd-tasks and tracks implementation progress]

## Task T001: Podział ChatClient na wyspecjalizowane hooki
**Status:** Pending  
**Dependencies:** None  
**Files:** `app/chat-client.tsx`, `app/lib/hooks/*` (nowe), `app/components/*` (jeśli wydzielone)

### Description
Wyodrębnij logikę połączenia głosowego, MCP tools, markdown i layoutu do osobnych hooków/małych komponentów. Zmniejsz rozmiar `ChatClient` i zachowaj dotychczasowe API UI.

### Acceptance Criteria
- ChatClient importuje i używa nowych hooków zamiast zagnieżdżonej logiki.
- Pokrycie nowych modułów ≥80% (Jest).
- E2E (`ui-*`, `mcp-*`, markdown) przechodzi bez zmian asercji.

### Implementation Notes
- Zachować kolejność importów wg AGENTS.md. Użyj hooks w `app/lib` lub blisko komponentu.

---

## Task T002: Higiena audio i cleanup zasobów
**Status:** Pending  
**Dependencies:** T001  
**Files:** `app/chat-client.tsx`, nowe hooki audio (jeśli wydzielone)

### Description
Zapewnij tworzenie i usuwanie elementu `<audio>` oraz zamykanie `AudioContext` przy umount/rozłączeniu. Zatrzymaj `requestAnimationFrame` gdy brak strumienia.

### Acceptance Criteria
- Audio element usuwany w cleanup hooka; brak osieroconych elementów po unmount (test).
- `AudioContext.close()` wywoływane podczas disconnect/unmount; brak ostrzeżeń w testach.
- Pętla `requestAnimationFrame` nie działa, gdy `srcObject` jest null/odłączone.

### Implementation Notes
- Dodaj test integracyjny/snapshot z mock runtime (NEXT_PUBLIC_USE_REALTIMEMOCK=1) sprawdzający brak wycieków.

---

## Task T003: Cache w /api/realtime-token
**Status:** Pending  
**Dependencies:** None  
**Files:** `app/api/realtime-token/route.ts`, ewentualnie `app/lib/realtime-instructions.ts` (cache control)

### Description
Wprowadź krótki cache (30–60 s lub do zmiany mtime instrukcji) dla client secret; umożliw wstrzyknięcie fetch/transportu w testach.

### Acceptance Criteria
- Cache HIT/MISS zgodny z mtime pliku instrukcji; logika nie omija zmian pliku.
- Testy: brak `OPENAI_API_KEY`, pusty plik, HIT/MISS cache, sukces z mokiem fetch.
- Endpoint nadal zwraca błąd 500 przy braku klucza; brak regresji bezpieczeństwa.

### Implementation Notes
- Rozważ prosty in-memory cache z timestampem; zadbaj o brak wyścigów w równoległych żądaniach.

---

## Task T004: Testy jakości i regresji
**Status:** Pending  
**Dependencies:** T001, T002, T003  
**Files:** `tests/chat/*`, `tests/api/*`, `tests/e2e/*`

### Description
Uzupełnij testy jednostkowe/integracyjne/e2e zgodnie z akceptacją: nowe hooki, cleanup audio, scenariusze token cache, stabilność istniejących e2e.

### Acceptance Criteria
- Nowe testy dla hooków i audio cleanup; pokrycie nowych plików ≥80%.
- Testy `/api/realtime-token` spełniają warianty z T003.
- E2E negatywne: przerwany SSE lub brak uprawnień MCP nie psuje klienta; istniejące scenariusze przechodzą.

### Implementation Notes
- Użyj istniejących fixtures (mock runtime, SSE) dla deterministycznych testów; trzymaj się limitu czasu Playwright z configu.

---

## Task T005: Dokumentacja i checklista SDD
**Status:** Pending  
**Dependencies:** T001–T004  
**Files:** `README.md` (krótka wzmianka), `sdd/features/refaktor-klienta-glownego-i-audio/tasks.md`, `sdd/features/refaktor-klienta-glownego-i-audio/spec.md`

### Description
Zaktualizuj dokumentację o zmianę architektury klienta/audio i cache tokenu. Oznacz zadania na Completed po wdrożeniu; dodaj minimalną notkę w README o cache tokenu.

### Acceptance Criteria
- README zawiera notkę o cache tokenu i wpływie na dev/CI.
- Spec/tasks uaktualnione do stanu faktycznego (T-status Completed po merge).
- Brak duplikacji z AGENTS.md; informacje zwięzłe.

### Implementation Notes
- Stosuj zasady z documentation-guide.md; sekcja w README krótka (1–2 zdania).
